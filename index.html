<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Mini Angry Birds Improved</title>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden;
    touch-action: none;
    background: linear-gradient(to top, #87ceeb 0%, #ffffff 100%);
    user-select: none;
  }
  #gameCanvas {
    display: block;
    background: #a3d9ff;
    margin: 0 auto;
    touch-action: none;
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    border-radius: 12px;
  }
  #info {
    position: fixed;
    top: 10px; left: 10px; right: 10px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #222;
    font-weight: bold;
    text-align: center;
    z-index: 10;
    user-select: none;
  }
  #levelMessage {
    background: rgba(255 255 255 / 0.85);
    border-radius: 12px;
    padding: 10px 20px;
    margin-bottom: 8px;
    font-size: 20px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  #restartBtn {
    cursor: pointer;
    background: #ff4136;
    border: none;
    border-radius: 8px;
    color: white;
    padding: 8px 16px;
    font-weight: bold;
    font-size: 16px;
    user-select: none;
    transition: background-color 0.3s ease;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }
  #restartBtn:hover {
    background: #ff6b5f;
  }
</style>
</head>
<body>
<div id="info">
  <div id="levelMessage">Level 1 - Knock down all the pigs üê∑!</div>
  <button id="restartBtn">Restart Level</button>
</div>
<canvas id="gameCanvas" width="375" height="667"></canvas>

<script>
// Mini Angry Birds Improved v2 by Gerald

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const W = canvas.width;
const H = canvas.height;

const gravity = 0.85;
const friction = 0.98;

let gameState = 'aim'; // 'aim', 'flying', 'reset', 'win'
let currentLevel = 0;
const totalLevels = 3;

const pigRadius = 16;
const birdRadius = 20;
const blockWidth = 40;
const blockHeight = 40;

const slingshotX = 80;
const slingshotY = H - 140;
const maxDragDist = 100;

let bird = null;
let blocks = [];
let pigs = [];

let aiming = false;
let aimPos = {x: slingshotX, y: slingshotY};

let score = 0;

function dist(x1,y1,x2,y2){
  return Math.hypot(x2 - x1, y2 - y1);
}

function rectCircleColliding(circle, rect){
  let distX = Math.abs(circle.x - rect.x - rect.w/2);
  let distY = Math.abs(circle.y - rect.y - rect.h/2);

  if (distX > (rect.w/2 + circle.r)) { return false; }
  if (distY > (rect.h/2 + circle.r)) { return false; }

  if (distX <= (rect.w/2)) { return true; }
  if (distY <= (rect.h/2)) { return true; }

  let dx=distX - rect.w/2;
  let dy=distY - rect.h/2;
  return (dx*dx + dy*dy <= (circle.r * circle.r));
}

function rectRectColliding(r1, r2){
  return !(r2.x > r1.x + r1.w ||
           r2.x + r2.w < r1.x ||
           r2.y > r1.y + r1.h ||
           r2.y + r2.h < r1.y);
}

class Bird {
  constructor(x,y){
    this.x = x;
    this.y = y;
    this.r = birdRadius;
    this.vx = 0;
    this.vy = 0;
    this.launched = false;
    this.color = '#ff4c4c';
    this.rotation = 0;
  }
  update(){
    if(this.launched){
      this.vy += gravity;
      this.x += this.vx;
      this.y += this.vy;
      this.vx *= friction;
      this.vy *= friction;
      this.rotation = Math.atan2(this.vy, this.vx);
      if(this.y > H + 50 || this.x > W + 50 || this.x < -50){
        gameState = 'reset';
      }
    }
  }
  draw(){
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);
    ctx.scale(-1, 1); // Mirror left facing bird

    // Body gradient
    let grad = ctx.createRadialGradient(0, 0, this.r*0.2, 0, 0, this.r);
    grad.addColorStop(0, '#ff6666');
    grad.addColorStop(1, '#b20000');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.ellipse(0, 0, this.r, this.r*0.75, 0, 0, Math.PI*2);
    ctx.fill();

    // Eye white
    ctx.beginPath();
    ctx.fillStyle = 'white';
    ctx.ellipse(-6, -5, 6, 8, 0, 0, Math.PI*2);
    ctx.fill();

    // Pupil
    ctx.beginPath();
    ctx.fillStyle = 'black';
    ctx.ellipse(-5, -3, 3, 4, 0, 0, Math.PI*2);
    ctx.fill();

    // Beak
    ctx.beginPath();
    ctx.fillStyle = 'orange';
    ctx.moveTo(this.r, 0);
    ctx.lineTo(this.r + 15, -8);
    ctx.lineTo(this.r + 15, 8);
    ctx.closePath();
    ctx.fill();

    // Shadow under bird
    ctx.shadowColor = 'rgba(0,0,0,0.3)';
    ctx.shadowBlur = 8;
    ctx.shadowOffsetX = 2;
    ctx.shadowOffsetY = 4;
    ctx.restore();
  }
}

class Block {
  constructor(x,y,w,h){
    this.x = x;
    this.y = y;
    this.w = w;
    this.h = h;
    this.vx = 0;
    this.vy = 0;
    this.mass = 2;
    this.isStatic = false;
    this.angle = 0;
    this.rotationSpeed = 0;
    this.color = '#8b5e3c';
    this.health = 3;
  }
  update(){
    if(!this.isStatic){
      this.vy += gravity;
      this.x += this.vx;
      this.y += this.vy;
      this.vx *= 0.7;
      this.vy *= 0.7;

      if(this.y + this.h > H - 50){
        this.y = H - 50 - this.h;
        this.vy = 0;
        this.vx *= 0.3;
      }

      this.angle += this.rotationSpeed;
      this.rotationSpeed *= 0.7;
    }
  }
  draw(){
    ctx.save();
    ctx.translate(this.x + this.w/2, this.y + this.h/2);
    ctx.rotate(this.angle);

    // Wood texture gradient
    let grad = ctx.createLinearGradient(-this.w/2, 0, this.w/2, 0);
    grad.addColorStop(0, '#d2b48c');
    grad.addColorStop(0.5, '#a97457');
    grad.addColorStop(1, '#6f4e37');
    ctx.fillStyle = grad;

    ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);

    // Wood grain lines
    ctx.strokeStyle = '#4b2e0a88';
    ctx.lineWidth = 2;
    for(let i = -this.h/2 + 5; i < this.h/2; i += 10){
      ctx.beginPath();
      ctx.moveTo(-this.w/2, i);
      ctx.lineTo(this.w/2, i+2);
      ctx.stroke();
    }
    ctx.restore();
  }
}

class Pig {
  constructor(x,y){
    this.x = x;
    this.y = y;
    this.r = pigRadius;
    this.alive = true;
    this.color = '#66bb6a';
  }
  draw(){
    if(!this.alive) return;
    ctx.save();
    ctx.translate(this.x, this.y);

    // Body gradient
    let grad = ctx.createRadialGradient(0, 0, this.r*0.2, 0, 0, this.r);
    grad.addColorStop(0, '#81c784');
    grad.addColorStop(1, '#2e7d32');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.ellipse(0, 0, this.r, this.r*0.85, 0, 0, Math.PI*2);
    ctx.fill();

    // Ears
    ctx.fillStyle = '#4caf50';
    ctx.beginPath();
    ctx.ellipse(-10, -15, 7, 9, Math.PI/5, 0, Math.PI*2);
    ctx.ellipse(10, -15, 7, 9, -Math.PI/5, 0, Math.PI*2);
    ctx.fill();

    // Eyes
    ctx.beginPath();
    ctx.fillStyle = 'white';
    ctx.ellipse(-7, -5, 5, 6, 0, 0, Math.PI*2);
    ctx.ellipse(7, -5, 5, 6, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.fillStyle = 'black';
    ctx.ellipse(-7, -5, 2, 3, 0, 0, Math.PI*2);
    ctx.ellipse(7, -5, 2, 3, 0, 0, Math.PI*2);
    ctx.fill();

    // Nose
    ctx.fillStyle = '#388e3c';
    ctx.beginPath();
    ctx.ellipse(0, 5, 8, 4, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = '#2e7d32';
    ctx.beginPath();
    ctx.ellipse(-3, 5, 2, 2, 0, 0, Math.PI*2);
    ctx.ellipse(3, 5, 2, 2, 0, 0, Math.PI*2);
    ctx.fill();

    // Shadow under pig
    ctx.shadowColor = 'rgba(0,0,0,0.3)';
    ctx.shadowBlur = 8;
    ctx.shadowOffsetX = 2;
    ctx.shadowOffsetY = 4;
    ctx.restore();
  }
}

const levels = [
  {
    blocks: [
      {x: 250, y: H - 90, w: 40, h: 40},
      {x: 290, y: H - 90, w: 40, h: 40},
      {x: 270, y: H - 130, w: 40, h: 40},
    ],
    pigs: [
      {x: 280, y: H - 160},
      {x: 320, y: H - 130},
    ],
  },
  {
    blocks: [
      {x: 230, y: H - 90, w: 40, h: 40},
      {x: 270, y: H - 90, w: 40, h: 40},
      {x: 310, y: H - 90, w: 40, h: 40},
      {x: 250, y: H - 130, w: 40, h: 40},
      {x: 290, y: H - 130, w: 40, h: 40},
      {x: 270, y: H - 170, w: 40, h: 40},
    ],
    pigs: [
      {x: 260, y: H - 160},
      {x: 320, y: H - 160},
      {x: 280, y: H - 200},
    ],
  },
  {
    blocks: [
      {x: 250, y: H - 90, w: 40, h: 40},
      {x: 250, y: H - 130, w: 40, h: 40},
      {x: 250, y: H - 170, w: 40, h: 40},
      {x: 290, y: H - 90, w: 40, h: 40},
      {x: 290, y: H - 130, w: 40, h: 40},
      {x: 330, y: H - 90, w: 40, h: 40},
      {x: 330, y: H - 130, w: 40, h: 40},
      {x: 290, y: H - 170, w: 40, h: 40},
    ],
    pigs: [
      {x: 270, y: H - 210},
      {x: 310, y: H - 210},
      {x: 300, y: H - 250},
      {x: 270, y: H - 150},
    ],
  }
];

function loadLevel(n){
  bird = new Bird(slingshotX, slingshotY);
  blocks = [];
  pigs = [];
  const lvl = levels[n];
  for(const b of lvl.blocks){
    let block = new Block(b.x, b.y, b.w, b.h);
    blocks.push(block);
  }
  for(const p of lvl.pigs){
    let pig = new Pig(p.x, p.y);
    pigs.push(pig);
  }
  gameState = 'aim';
  score = 0;
  aiming = false;
  aimPos.x = slingshotX;
  aimPos.y = slingshotY;
  document.getElementById('levelMessage').textContent = `Level ${n+1} - Knock down all the pigs üê∑!`;
}

function handleBirdBlockCollisions(){
  for(const block of blocks){
    if(block.isStatic) continue;
    if(rectCircleColliding({x:bird.x,y:bird.y,r:bird.r}, block)){
      bird.vx = -bird.vx * 0.6;
      bird.vy = -bird.vy * 0.6;
      block.vx += bird.vx * 0.3;
      block.vy += bird.vy * 0.3;
      block.rotationSpeed += (bird.vx + bird.vy)*0.05;
      block.health -= 1;
      if(block.health <= 0){
        block.isStatic = true;
        block.color = '#65432188';
      }
    }
  }
}

function handleBirdPigCollisions(){
  for(const pig of pigs){
    if(!pig.alive) continue;
    let d = dist(bird.x, bird.y, pig.x, pig.y);
    if(d < bird.r + pig.r){
      pig.alive = false;
      score++;
      bird.vx *= 0.7;
      bird.vy *= 0.7;
    }
  }
}

function handleBlockPigCollisions(){
  for(const pig of pigs){
    if(!pig.alive) continue;
    for(const block of blocks){
      if(block.isStatic) continue;
      let d = dist(pig.x, pig.y, block.x + block.w/2, block.y + block.h/2);
      if(d < pig.r + Math.max(block.w, block.h)/2){
        pig.alive = false;
        score++;
      }
    }
  }
}

function getPos(evt){
  if(evt.touches) {
    return {x: evt.touches[0].clientX, y: evt.touches[0].clientY};
  } else {
    return {x: evt.clientX, y: evt.clientY};
  }
}

canvas.addEventListener('pointerdown', e=>{
  if(gameState !== 'aim') return;
  let pos = getPos(e);
  if(dist(pos.x,pos.y,bird.x,bird.y) < bird.r + 30){
    aiming = true;
  }
});

canvas.addEventListener('pointermove', e=>{
  if(!aiming) return;
  let pos = getPos(e);
  let dx = pos.x - slingshotX;
  let dy = pos.y - slingshotY;
  let distDrag = Math.min(Math.hypot(dx, dy), maxDragDist);
  let angle = Math.atan2(dy, dx);
  // New aim position limited within circle maxDragDist
  aimPos.x = slingshotX + Math.cos(angle) * distDrag;
  aimPos.y = slingshotY + Math.sin(angle) * distDrag;

  // Bird moves with drag
  bird.x = aimPos.x;
  bird.y = aimPos.y;
});

canvas.addEventListener('pointerup', e=>{
  if(!aiming) return;
  aiming = false;
  // Calculate launch velocity based on stretch vector (opposite direction)
  let dx = aimPos.x - slingshotX;
  let dy = aimPos.y - slingshotY;

  bird.vx = -dx * 0.18;
  bird.vy = -dy * 0.18;
  bird.launched = true;
  gameState = 'flying';
});

document.getElementById('restartBtn').onclick = () => {
  loadLevel(currentLevel);
};

function update(){
  if(gameState === 'flying'){
    bird.update();
    for(const block of blocks){
      block.update();
    }
    handleBirdBlockCollisions();
    handleBirdPigCollisions();
    handleBlockPigCollisions();

    if(pigs.every(p => !p.alive)){
      gameState = 'win';
      setTimeout(() => {
        currentLevel++;
        if(currentLevel >= totalLevels){
          alert('Congrats! You beat all levels! üéâ');
          currentLevel = 0;
        }
        loadLevel(currentLevel);
      }, 1000);
    }

    if(gameState === 'flying' && 
      (Math.abs(bird.vx) < 0.1 && Math.abs(bird.vy) < 0.1 || 
       bird.x < -50 || bird.x > W + 50 || bird.y > H + 50)){
      gameState = 'reset';
    }
  } else if(gameState === 'reset'){
    loadLevel(currentLevel);
  }
}

function drawSlingshotBase(){
  ctx.lineWidth = 6;
  ctx.strokeStyle = '#553311';
  ctx.beginPath();
  ctx.moveTo(slingshotX - 20, slingshotY + 40);
  ctx.lineTo(slingshotX + 20, slingshotY + 40);
  ctx.stroke();
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(slingshotX, slingshotY);
  ctx.lineTo(slingshotX - 15, slingshotY + 40);
  ctx.lineTo(slingshotX + 15, slingshotY + 40);
  ctx.closePath();
  ctx.fillStyle = '#663300';
  ctx.fill();
}

function drawSlingshotBands(){
  if(gameState === 'aim' && (aiming || (bird.x !== slingshotX || bird.y !== slingshotY))){
    ctx.lineWidth = 5;
    ctx.strokeStyle = '#a33';
    ctx.lineCap = 'round';

    // Left band
    ctx.beginPath();
    ctx.moveTo(slingshotX - 15, slingshotY + 40);
    ctx.lineTo(bird.x, bird.y);
    ctx.stroke();

    // Right band
    ctx.beginPath();
    ctx.moveTo(slingshotX + 15, slingshotY + 40);
    ctx.lineTo(bird.x, bird.y);
    ctx.stroke();
  }
}

function drawAimLine(){
  if(aiming){
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'rgba(255, 0, 0, 0.7)';
    ctx.beginPath();
    ctx.moveTo(bird.x, bird.y);
    ctx.lineTo(slingshotX, slingshotY);
    ctx.stroke();
  }
}

function draw(){
  ctx.clearRect(0, 0, W, H);

  // Ground
  ctx.fillStyle = '#4CAF50';
  ctx.fillRect(0, H - 50, W, 50);

  drawSlingshotBands();
  drawSlingshotBase();

  for(const block of blocks){
    block.draw();
  }

  for(const pig of pigs){
    pig.draw();
  }

  bird.draw();

  drawAimLine();

  if(gameState === 'aim' && !aiming){
    ctx.fillStyle = '#222';
    ctx.font = '16px Segoe UI, sans-serif';
    ctx.fillText('Drag the bird and release to shoot!', 40, H - 15);
  }
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

loadLevel(currentLevel);
loop();

</script>
</body>
</html>
